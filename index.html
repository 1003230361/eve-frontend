<!DOCTYPE html>
<html>
<head>
    <title>EVEè§’è‰²åŠ©æ‰‹</title>
    <meta charset="utf-8">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #1a1a1a; color: #fff; min-height: 100vh; }
        .card-dark { background: #2d2d2d; border: 1px solid #444; }
        .nav-pills .nav-link { color: #8ab4f8; }
        .nav-pills .nav-link.active { background: #0d6efd!important; }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login" class="container mt-5 text-center">
        <img src="https://web.ccpgamescdn.com/eveonlineassets/developers/eve-sso-login-black-small.png" 
             alt="EVEç™»å½•" 
             style="cursor:pointer;"
             onclick="EVElogin()">
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div id="loggedIn" style="display:none;">
        <!-- å¯¼èˆªæ  -->
        <nav class="nav nav-pills justify-content-center p-3 bg-dark">
            <button class="nav-link active" data-page="page1">è§’è‰²åŸºç¡€</button>
            <button class="nav-link" data-page="page2">æŠ€èƒ½ä¿¡æ¯</button>
            <button class="nav-link" data-page="page3">LPä¿¡æ¯</button>
            <button class="nav-link" data-page="page4">å†›å›¢å»ºç­‘</button>
        </nav>

        <!-- åˆ†é¡µå†…å®¹ -->
        <div class="container mt-4">
            <div id="page1" class="page">
                <div class="card card-dark">
                    <div class="card-body" id="basicInfo"></div>
                </div>
            </div>
            
            <div id="page2" class="page" style="display:none;">
                <div class="card card-dark">
                    <div class="card-body" id="skillInfo"></div>
                </div>
            </div>

            <div id="page3" class="page" style="display:none;">
                <div class="card card-dark">
                    <div class="card-body">
                        <select id="lpCorp" class="form-select mb-3 bg-dark text-light">
                            <option value="">é€‰æ‹©LPå•†åº—...</option>
                        </select>
                        <div id="lpInfo"></div>
                    </div>
                </div>
            </div>

            <div id="page4" class="page" style="display:none;">
                <div class="card card-dark">
                    <div class="card-body">
                        <div class="row g-3" id="structureInfo"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- ä¾èµ–åº“ -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
// é…ç½®ä¿¡æ¯ ============================================
const config = {
    clientID: "9515a447fe744949b7250863c9d85634",         // â† ä¿®æ”¹1ï¼šæ›¿æ¢ä½ çš„Client ID
    callbackURL: "https://1003230361.github.io/eve-seat-personal/", // â† ä¿®æ”¹2ï¼šéƒ¨ç½²æ—¶æ”¹ä¸ºGitHub Pagesåœ°å€
    esiBase: "https://esi.evetech.net/latest"
};

// æ ¸å¿ƒåŠŸèƒ½ ============================================
// ç™»å½•åŠŸèƒ½
function EVElogin() {
    const state = Math.random().toString(36).substring(2, 15);
    sessionStorage.setItem("auth_state", state);
    
    const authURL = new URL("https://login.eveonline.com/v2/oauth/authorize");
    authURL.searchParams.append("response_type", "code");
    authURL.searchParams.append("client_id", config.clientID);
    authURL.searchParams.append("redirect_uri", config.callbackURL);
    authURL.searchParams.append("scope", [
        "esi-characters.read_standings.v1",
        "esi-wallet.read_character_wallet.v1"
    ].join(" "));
    authURL.searchParams.append("state", state);
    
    window.location.href = authURL.toString();
}

// åˆ†é¡µ1ï¼šè§’è‰²åŸºç¡€ä¿¡æ¯
async function loadBasicInfo() {
    showLoading('#basicInfo');
    try {
        const [charData, wallet] = await Promise.all([
            esiRequest(`/characters/${getCharID()}/`),
            esiRequest(`/characters/${getCharID()}/wallet/`)
        ]);
        
        $('#basicInfo').html(`
            <h4>${charData.name}</h4>
            <p>è§’è‰²IDï¼š${getCharID()}</p>
            <p>ğŸ’° é’±åŒ…ï¼š${wallet.toLocaleString()} ISK</p>
            <p>â³ æ¬§ç±³èŒ„ï¼š${charData.omega_expiry ? 
                new Date(charData.omega_expiry).toLocaleDateString() : 'æœªæ¿€æ´»'}</p>
        `);
    } catch (e) {
        showError('#basicInfo', e);
    }
}

// åˆ†é¡µ2ï¼šæŠ€èƒ½ä¿¡æ¯
async function loadSkillInfo() {
    showLoading('#skillInfo');
    try {
        const [attributes, queue] = await Promise.all([
            esiRequest(`/characters/${getCharID()}/attributes/`),
            esiRequest(`/characters/${getCharID()}/skillqueue/`)
        ]);
        
        const currentSkill = queue[0] || {};
        $('#skillInfo').html(`
            <h5>å±æ€§å€¼</h5>
            <div class="row">
                <div class="col">æ™ºåŠ›: ${attributes.intelligence}</div>
                <div class="col">æ„ŸçŸ¥: ${attributes.perception}</div>
                <div class="col">é­…åŠ›: ${attributes.charisma}</div>
            </div>
            <h5 class="mt-3">å½“å‰è®­ç»ƒ</h5>
            <p>${currentSkill.skill_name || 'æ— '} (${currentSkill.finished_level || '0'}/5)</p>
            <p>å‰©ä½™æ—¶é—´ï¼š${formatTime(currentSkill.finish_date)}</p>
        `);
    } catch (e) {
        showError('#skillInfo', e);
    }
}

// åˆ†é¡µ3ï¼šLPä¿¡æ¯
async function loadLPInfo() {
    showLoading('#lpInfo');
    try {
        const lpData = await esiRequest(`/characters/${getCharID()}/loyalty/points/`);
        $('#lpCorp').html('<option value="">é€‰æ‹©LPå•†åº—...</option>' + 
            lpData.map(corp => `<option value="${corp.corporation_id}">${corp.corporation_name}</option>`));
        
        $('#lpCorp').change(async function() {
            const corpID = $(this).val();
            const corpData = lpData.find(c => c.corporation_id == corpID);
            $('#lpInfo').html(corpData ? 
                `å½“å‰LPï¼š${corpData.loyalty_points.toLocaleString()}` : 'è¯·é€‰æ‹©å†›å›¢');
        });
    } catch (e) {
        showError('#lpInfo', e);
    }
}

// åˆ†é¡µ4ï¼šå†›å›¢å»ºç­‘
async function loadStructures() {
    showLoading('#structureInfo');
    try {
        const structures = await esiRequest('/corporation/structures/'); // éœ€è¦å†›å›¢èŒƒå›´æƒé™
        $('#structureInfo').html(structures.map(s => `
            <div class="col-md-4">
                <div class="card card-dark mb-3">
                    <div class="card-body">
                        <h5>${s.name}</h5>
                        <p>ç±»å‹ï¼š${s.type_id}</p>
                        <p>ç‡ƒæ–™å‰©ä½™ï¼š${s.fuel_expires ? formatTime(s.fuel_expires) : 'æ— '}</p>
                        <input type="number" class="form-control bg-dark text-light mb-2" 
                               placeholder="ç›®æ ‡å¤©æ•°" id="days-${s.structure_id}">
                        <button class="btn btn-primary btn-sm" 
                            onclick="calculateFuel(${s.structure_id}, ${s.fuel_expires}, ${24})">
                            è®¡ç®—ç‡ƒæ–™
                        </button>
                    </div>
                </div>
            </div>
        `).join(''));
    } catch (e) {
        showError('#structureInfo', e);
    }
}

// å·¥å…·å‡½æ•° ============================================
function esiRequest(endpoint) {
    return $.ajax({
        url: config.esiBase + endpoint,
        headers: { 'Authorization': `Bearer ${sessionStorage.getItem('access_token')}` }
    });
}

function getCharID() {
    return sessionStorage.getItem('characterID');
}

function formatTime(dateString) {
    if (!dateString) return '-';
    const diff = new Date(dateString) - Date.now();
    return `${Math.floor(diff / 86400000)}å¤©`;
}

function showLoading(selector) {
    $(selector).html('<div class="spinner-border text-primary"></div> åŠ è½½ä¸­...');
}

function showError(selector, error) {
    $(selector).html(`<div class="alert alert-danger">é”™è¯¯ï¼š${error.statusText || 'è¯·æ±‚å¤±è´¥'}</div>`);
}

// åˆå§‹åŒ– ==============================================
$(document).ready(function() {
    // å¤„ç†ç™»å½•å›è°ƒ
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    const state = params.get('state');

    if (code && state) {
        if (state !== sessionStorage.getItem('auth_state')) {
            return alert('å®‰å…¨éªŒè¯å¤±è´¥!');
        }
        
        // è·å–è®¿é—®ä»¤ç‰Œï¼ˆéœ€è¦åç«¯æ”¯æŒï¼Œæ­¤å¤„ä¸ºç¤ºä¾‹ï¼‰
        fetch('https://your-backend-service.com/token', { // â† ä¿®æ”¹3ï¼šæ›¿æ¢ä¸ºä½ çš„åç«¯
            method: 'POST',
            body: JSON.stringify({ code, client_id: config.clientID })
        }).then(r => r.json()).then(data => {
            sessionStorage.setItem('access_token', data.access_token);
            sessionStorage.setItem('characterID', data.CharacterID);
            $('#login').hide();
            $('#loggedIn').show();
            loadBasicInfo();
        });
    }

    // åˆ†é¡µåˆ‡æ¢äº‹ä»¶
    $('[data-page]').click(function() {
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
        $('.page').hide();
        $('#'+$(this).data('page')).show();
        
        // æŒ‰éœ€åŠ è½½æ•°æ®
        switch($(this).data('page')) {
            case 'page2': loadSkillInfo(); break;
            case 'page3': loadLPInfo(); break;
            case 'page4': loadStructures(); break;
        }
    });
});
</script>
</body>
</html>